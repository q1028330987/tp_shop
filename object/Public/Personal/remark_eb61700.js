$(function(){VIVO_UI.HighLightMyCenterNav("未评价商品");var t='<li class="image-item image upload-image"><div class="mask"></div><i class="delete"></i></li>',e=!0,i=function(e,i,a){a.before($(t).prepend($("<img/>").attr({src:imghostUrl+i,absOriUrl:e,absThumbUrl:i})))},a=function(t,e,i,a,n){new Dialog({title:t,content:e,icon:i,confirmBtn:!0,cancelBtn:a,confirmCallback:n})},n=function(t){var e=t.siblings(".image").size();e>=3?t.hide():t.removeClass("loading").show()};$(".uploadFile").fileupload({url:webCtx+"/my/remark/upload-image?t="+(new Date).getTime(),dataType:"json",autoUpload:!0,sequentialUploads:!0,done:function(t,s){var r=$(this).parent();if(200==s.result.retCode){var o=s.result.retMsg.bigPic,l=s.result.retMsg.thumbnailPic;i(o,l,$(this).parent())}else 410==s.result.retCode?a("上传失败","图片格式错误或非图片！","warning"):420==s.result.retCode?a("上传失败","图片大小不能超过6M！","warning"):a("上传失败","系统繁忙，请稍后重试！","warning");n(r),e=!0},fail:function(t,i){var s=$(this).parent();i.total>6e6?a("上传失败","图片大小不能超过6M！","warning"):a("上传失败","系统繁忙，请稍后重试！","warning"),n(s),e=!0}}).bind("fileuploadadd",function(){$(this).parent().addClass("loading"),e=!1}),$("body").on("click",".image-item.image.upload-image",function(){var t=$(this).siblings(".image-item.fileinput-button");$(this).remove(),n(t)}),$("body").on("mouseover",".stars-box>i",function(){var t=$(this).parent().attr("score");$(this).index()>t-2&&($(this).addClass("on").prevAll().addClass("on"),$(this).nextAll().removeClass("on"))}),$("body").on("click",".stars-box>i",function(){var t=$(this).parent().next("span.error-style");t.size()>0&&t.remove(),$(this).parent().attr({score:$(this).index()+1});var e=$(this).index()+1;$(this).parent().find("i").each(function(){$(this).index()<e?$(this).addClass("on"):$(this).removeClass("on")})}),$("body").on("mouseout",".stars-box>i",function(){var t=$(this).parent().attr("score");$(this).parent().find("i").each(function(){$(this).index()<t?$(this).addClass("on"):$(this).removeClass("on")})}),$("body").on("click",".unfold, .fold",function(){var t=$(this).parent().parent(".prod-line").next(".evaluated-info");$(this).is(".unfold")?($(this).removeClass("unfold").addClass("fold"),$(".evaluate-text-content").trigger("propertychange")):($(this).removeClass("fold").addClass("unfold"),c(t)),t.toggle()});var s,r=function(){$(this).is(":disabled")?$(this).removeClass("btn-cancel").addClass("btn-blue").removeAttr("disabled"):$(this).removeClass("btn-blue").addClass("btn-cancel").attr("disabled","disabled")},o="8.0",l=navigator.userAgent.toLowerCase(),d=l.indexOf("msie")>-1;d?(s=l.match(/msie ([\d.]+)/)[1],o>=s&&$("body").on("keyup",".evaluate-text-content",function(){var t=$(this).val().length;if(t>=2){var e=$(this).next("span.error-style");e.size()>0&&e.remove()}t>=200&&$(this).val($(this).val().substr(0,200)),$(this).parent().find(".text-size").text($(this).val().length)})):$("body").on("input propertychange",".evaluate-text-content",function(){var t=$(this).val().length;if(t>=2){var e=$(this).next("span.error-style");e.size()>0&&e.remove()}t>=200&&$(this).val($(this).val().substr(0,200)),$(this).parent().find(".text-size").text($(this).val().length)});var c=function(t){var e=$(t).find("span.error-style");e.size()>0&&e.each(function(){$(this).remove()})};$("body").on("click",".submit-evaluate",function(){if(!e)return void a("","图片正在上传中！","warning");var t=$(this).parents("tr.evaluated-info");c(t);var i=$(this),n=i.parents(".evaluate-box"),s=n.find(".evaluate-text-content");r.call(this);var o={},l=!0;return o.spuId=$(this).attr("spuId"),o.skuId=$(this).attr("skuId"),o.spuTitle=$(this).attr("spuTitle"),o.orderNo=$(this).attr("orderNo"),n.find("span.stars-box").each(function(){var t=$(this).attr("score");0==t&&(l=!1,$(this).after("<span class='error-style red'>您的评星是我们前进的动力！</span>")),o[$(this).attr("key")]=t}),o.content=$.trim(s.val()),(o.content.length<2||o.content.length>200)&&(l=!1,s.after("<span class='error-style red'>麻烦填写2-200字哦！</span>"),s.val(o.content),s.trigger("propertychange")),l?(n.find(".evaluate-text .image").each(function(){o["picture"+($(this).index()+1)]=$(this).find("img").attr("absOriUrl"),o["picture"+($(this).index()+1)+"Thumbnail"]=$(this).find("img").attr("absThumbUrl")}),o.hasPicture=n.find(".evaluate-text .image").size()>0?1:0,void $.ajax({url:webCtx+"/my/remark/add",type:"POST",data:o,dataType:"json",success:function(t){200==t.retCode?a("","感谢您的分享！","success",null,function(){window.location.href=window.location}):222==t.retCode?a("","评价成功，全款预定商品评价将会在全面开售后显示！","success",null,function(){window.location.href=window.location}):(a("评论失败","系统错误，请稍后重试！","warning"),r.call(i.get(0)))},error:function(t){0==t.status?window.location.href=window.location:(r.call(i.get(0)),window.location.href=webCtx+"/error/forbidden")}})):void r.call(this)})});